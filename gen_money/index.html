<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>City Manager Financeiro</title>
    <style>
        /* --- Configurações Globais e Variáveis de Cor (Modo Escuro) --- */
        :root {
            --cor-fundo: #2c3e50;
            --cor-terreno: #4a4a4a;
            --cor-terreno-hover: #5a5a5a;
            --cor-terreno-fundo: #1e272e;
            --cor-menu: #34495e;
            --cor-sombra: rgba(0, 0, 0, 0.4);
            --cor-texto: #ecf0f1;
            --cor-dinheiro-display: #f1c40f;
            --cor-dinheiro-popup: #55efc4;
            --cor-renda-display: #00cec9;
            --cor-investido-display: #8e44ad;
            --cor-retido-display: #e67e22;
            --cor-selecao: #3498db;
            --cor-demolir: #e74c3c;
            --cor-investimento: #9b59b6;
            --cor-sucesso: #27ae60;
            --cor-cinza: #7f8c8d;
        }

        body, html {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--cor-fundo);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }
        
        body.demolish-mode .terrain-plot.occupied { cursor: crosshair; }
        body.demolish-mode .terrain-plot.occupied:hover { background-color: var(--cor-demolir); transform: scale(1.05); }
        .terrain-plot.investment-plot.occupied { cursor: pointer; }

        /* --- Barra Superior (Mostradores) --- */
        #top-bar {
            position: fixed; top: 20px; left: 20px; background-color: var(--cor-menu);
            padding: 10px 20px; border-radius: 15px; box-shadow: 0 6px 12px var(--cor-sombra);
            z-index: 1000; display: flex; align-items: center; gap: 25px; border: 1px solid #485460;
            transition: all 0.3s ease;
        }

        #time-display-container {
            position: fixed; top: 20px; right: 20px; background-color: var(--cor-menu);
            padding: 10px 20px; border-radius: 15px; box-shadow: 0 6px 12px var(--cor-sombra);
            z-index: 1000; display: flex; align-items: center; gap: 15px;
            color: var(--cor-texto); font-size: 1.5em; font-weight: bold;
        }

        #clock-display { font-family: 'Courier New', Courier, monospace; }
        .display-group { display: flex; align-items: center; gap: 10px; }
        #money-display { font-size: 2.2em; font-weight: bold; color: var(--cor-dinheiro-display); }
        #total-invested-display { font-size: 1.5em; font-weight: bold; color: var(--cor-investido-display); }
        #retained-earnings-display { font-size: 1.5em; font-weight: bold; color: var(--cor-retido-display); }
        #income-rate-display { font-size: 1.5em; font-weight: bold; color: var(--cor-renda-display); }
        #income-time-unit { cursor: pointer; text-decoration: underline dotted; font-size: 1.2em; color: #bdc3c7; }

        .money-control-btn {
            font-size: 1.8em; font-weight: bold; color: #fff; cursor: pointer; border: none;
            width: 35px; height: 35px; border-radius: 50%; display: flex; justify-content: center;
            align-items: center; transition: all 0.2s ease;
            box-shadow: 0 3px 5px rgba(0,0,0,0.2);
        }
        #add-money { background-color: var(--cor-sucesso); }
        #subtract-money { background-color: var(--cor-demolir); }
        .money-control-btn:hover { transform: scale(1.1); filter: brightness(1.1); }
        .money-control-btn:active { transform: scale(1.05); filter: brightness(0.9); }

        /* --- Container Principal do Jogo --- */
        #game-container {
            display: flex; gap: 20px; margin-top: 100px; padding: 20px;
            background: var(--cor-terreno-fundo); border-radius: 15px; box-shadow: 0 10px 20px var(--cor-sombra);
        }

        /* --- Terreno (Grid de Construção) --- */
        #terrain {
            display: grid; grid-template-columns: repeat(10, 70px); grid-template-rows: repeat(7, 70px);
            gap: 5px; padding: 10px; background-color: var(--cor-terreno-fundo); border-radius: 10px;
        }

        .terrain-plot {
            width: 70px; height: 70px; background-color: var(--cor-terreno); border-radius: 5px;
            cursor: pointer; transition: background-color 0.2s, transform 0.2s, box-shadow 0.2s;
            position: relative; display: flex; justify-content: center; align-items: center;
        }
        .terrain-plot:hover { z-index: 10; transform: scale(1.05); }
        .terrain-plot.drag-over { background-color: var(--cor-terreno-hover); box-shadow: inset 0 0 10px var(--cor-selecao); }
        .terrain-plot.occupied:not(.investment-plot) { cursor: not-allowed; }

        .plot-emoji { font-size: 50px; line-height: 1; pointer-events: none; text-shadow: 2px 2px 3px rgba(0,0,0,0.3); }
        .plot-balance {
            position: absolute; bottom: 2px; left: 0; right: 0;
            font-size: 11px; font-weight: bold; color: white; background-color: rgba(0,0,0,0.5);
            text-align: center; border-radius: 3px; padding: 1px 0; pointer-events: none;
        }
        .plot-reinvest-indicator {
            position: absolute; top: 4px; right: 4px; font-size: 14px;
            text-shadow: 0 0 4px black; z-index: 2; pointer-events: none;
        }

        /* --- Menu Lateral --- */
        #build-menu {
            width: 220px; background-color: var(--cor-menu); padding: 20px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.2); border-radius: 10px;
            display: flex; flex-direction: column; gap: 15px;
        }
        #build-menu hr { border: none; border-top: 1px solid #485460; }
        #build-menu h3 {
            margin: 0 0 10px 0; text-align: center; color: var(--cor-texto); font-size: 1.4em;
            border-bottom: 2px solid #485460; padding-bottom: 10px;
        }

        .build-option {
            padding: 10px; border: 3px solid transparent; border-radius: 8px; cursor: grab;
            transition: all 0.2s ease; text-align: center;
            background-color: #485460; position: relative;
        }
        .build-option.investment-type { border-left: 5px solid var(--cor-investimento); }
        .build-option:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .build-option:active:not(.tool-btn) { cursor: grabbing; transform: translateY(0); }
        .build-option.dragging { opacity: 0.5; border-style: dashed; transform: scale(0.95); }

        #demolish-tool.selected { border-color: var(--cor-demolir); background-color: #5d3d3a; }
        
        #menu-tools { display: flex; gap: 10px; }
        #menu-tools .build-option { 
            flex: 1; 
            cursor: pointer; 
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 5px;
        }
        
        #custom-buildings-container {
            max-height: 350px;
            overflow-y: auto;
            padding: 4px;
            display: flex;
            flex-direction: column;
            gap: 10px; 
        }
        #custom-buildings-container::-webkit-scrollbar { width: 8px; }
        #custom-buildings-container::-webkit-scrollbar-track { background: var(--cor-terreno-fundo); border-radius: 4px; }
        #custom-buildings-container::-webkit-scrollbar-thumb { background-color: var(--cor-cinza); border-radius: 4px; }
        
        .menu-emoji { font-size: 50px; pointer-events: none; }
        #menu-tools .menu-emoji { font-size: 40px; }

        .build-info { font-size: 0.9em; color: var(--cor-texto); pointer-events: none; margin-top: 5px; }
        .build-info strong { font-size: 1.1em; color: var(--cor-texto); display: block; margin-bottom: 4px; }
        .editable-income-input { width: 80px; text-align: center; border: 1px solid var(--cor-selecao); border-radius: 4px; background-color: #555; color: var(--cor-texto);}

        .type-controls { position: absolute; top: 2px; right: 2px; display: flex; gap: 2px; z-index: 2; }
        .type-control-btn {
            background: rgba(0, 0, 0, 0.2); border: 1px solid rgba(255,255,255,0.1); border-radius: 5px;
            cursor: pointer; width: 20px; height: 20px; font-size: 12px; font-weight: bold; line-height: 18px; color: white;
            transition: all 0.2s ease;
        }
        .type-control-btn:hover { background: rgba(0, 0, 0, 0.4); transform: scale(1.1); }
        
        .income-percentage {
            position: absolute; top: 2px; left: 2px; background: rgba(0, 0, 0, 0.5);
            color: white; padding: 2px 4px; border-radius: 4px;
            font-size: 10px; font-weight: bold; z-index: 1;
        }

        /* --- Pop-up de Dinheiro --- */
        .money-popup {
            position: absolute; top: 50%; left: 50%; color: var(--cor-dinheiro-popup); font-size: 1.4em;
            font-weight: bold; text-shadow: 0 0 8px rgba(0, 0, 0, 0.9);
            animation: floatUpAndFade 1s ease-out forwards; pointer-events: none;
            z-index: 100; white-space: nowrap;
        }
        @keyframes floatUpAndFade { 0% { opacity: 1; transform: translate(-50%, -50%); } 100% { opacity: 0; transform: translate(-50%, -150%); } }

        /* --- Modals (Genérico) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.7); display: none;
            justify-content: center; align-items: center; z-index: 2000;
        }
        .modal-container {
            background-color: var(--cor-menu); padding: 25px; border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 320px;
            border: 1px solid #485460; color: var(--cor-texto);
            animation: modal-fade-in 0.3s ease-out;
        }
        @keyframes modal-fade-in { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        
        .modal-container h2 { margin-top: 0; text-align: center; }
        .modal-container p { text-align: center; }
        .modal-buttons { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .modal-buttons button {
            padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;
            font-weight: bold; transition: all 0.2s ease;
        }
        .modal-buttons button:hover { filter: brightness(1.1); }
        .modal-buttons button:active { filter: brightness(0.9); transform: scale(0.98); }
        
        /* --- Formulário de Criação/Edição --- */
        #creation-form, #investment-form { display: flex; flex-direction: column; gap: 15px; }
        #creation-form label, #investment-form label { font-weight: bold; color: var(--cor-texto); }
        #creation-form input, #investment-form input { padding: 8px; border-radius: 5px; border: 1px solid #777; background-color: #555; color: var(--cor-texto);}
        #creation-form .form-row { display: flex; align-items: center; gap: 10px;}
        .form-field-group { display: flex; flex-direction: column; gap: 5px; }
        
        #save-building-btn { background-color: var(--cor-sucesso); color: white; }
        #cancel-building-btn, #confirm-no-btn, #investment-cancel-btn { background-color: var(--cor-cinza); color: white;}
        #withdraw-btn { background-color: #e67e22; color: white;}
        #deposit-btn { background-color: #2980b9; color: white;}
        #confirm-yes-btn { background-color: var(--cor-demolir); color: white; }
    </style>
</head>
<body>

    <div id="top-bar">
        <div class="display-group">
            <div id="money-display">R$ 0,00</div>
            <button id="subtract-money" class="money-control-btn" title="Subtrair dinheiro">-</button>
            <button id="add-money" class="money-control-btn" title="Adicionar dinheiro">+</button>
        </div>
        <div class="display-group">
            <span style="font-size: 1.5em;" title="Ganhos Retidos">🏦</span>
            <div id="retained-earnings-display">R$ 0,00</div>
        </div>
        <div class="display-group">
            <span style="font-size: 1.5em;" title="Total Investido">🐷</span>
            <div id="total-invested-display">R$ 0,00</div>
        </div>
        <div class="display-group">
            <div id="income-rate-display">+R$ 0,00</div>
            <span id="income-time-unit">/s</span>
        </div>
    </div>
    
    <div id="time-display-container">
        <span id="date-display"></span>
        <span id="clock-display"></span>
    </div>

    <div id="game-container">
        <div id="terrain"></div>
        <div id="build-menu">
            <h3>Ferramentas</h3>
            <div id="menu-tools">
                <div id="create-building-btn" class="build-option tool-btn">
                     <span class="menu-emoji">➕</span>
                     <div class="build-info"><strong>Criar</strong></div>
                </div>
                <div id="demolish-tool" class="build-option tool-btn">
                     <span class="menu-emoji">🗑️</span>
                     <div class="build-info"><strong>Demolir</strong></div>
                </div>
                <div id="reset-game-btn" class="build-option tool-btn">
                    <span class="menu-emoji">🔄</span>
                    <div class="build-info"><strong>Resetar</strong></div>
               </div>
            </div>
            <hr>
            <div id="custom-buildings-container"></div>
        </div>
    </div>
    
    <div id="form-modal" class="modal-overlay">
        <div class="modal-container">
            <h2 id="form-title">Nova Construção</h2>
            <form id="creation-form">
                <div class="form-row">
                    <label for="is-investment-checkbox">É um investimento?</label>
                    <input type="checkbox" id="is-investment-checkbox">
                </div>
                <div class="form-field-group">
                    <label for="building-name">Nome:</label>
                    <input type="text" id="building-name" required>
                </div>
                 <div class="form-field-group">
                    <label for="building-emoji">Emoji:</label>
                    <input type="text" id="building-emoji" required>
                </div>

                <div class="income-field form-field-group">
                    <label for="building-income">Renda Mensal (R$):</label>
                    <input type="text" inputmode="decimal" id="building-income" required placeholder="ex: 1250,55">
                     <div class="form-field-group">
                        <div class="form-row">
                           <label for="payday-checkbox">Ativar Dia de Pagamento?</label>
                           <input type="checkbox" id="payday-checkbox">
                        </div>
                        <div id="payday-input-group" style="display: none;" class="form-field-group">
                            <label for="payday-day">Dia do Pagamento (1-31):</label>
                            <input type="number" id="payday-day" min="1" max="31">
                        </div>
                     </div>
                     <div class="form-field-group">
                        <div class="form-row">
                           <label for="work-schedule-checkbox">Ativar Horário de Trabalho?</label>
                           <input type="checkbox" id="work-schedule-checkbox">
                        </div>
                        <div id="work-schedule-input-group" style="display: none;">
                            <div class="form-row">
                                <label for="work-start-time">Início:</label>
                                <input type="time" id="work-start-time">
                                <label for="work-end-time">Fim:</label>
                                <input type="time" id="work-end-time">
                            </div>
                        </div>
                     </div>
                </div>

                <div class="apy-field form-field-group" style="display: none;">
                    <label for="building-apy">Rendimento Anual (%):</label>
                    <input type="text" inputmode="decimal" id="building-apy" required placeholder="ex: 5.5">
                    <label for="initial-deposit">Aporte Inicial (Opcional):</label>
                    <input type="text" inputmode="decimal" id="initial-deposit" placeholder="1000,00">
                    <div class="form-row">
                        <label for="auto-reinvest-checkbox">Reinvestir Lucro Automaticamente?</label>
                        <input type="checkbox" id="auto-reinvest-checkbox" checked>
                    </div>
                </div>
                
                <div class="modal-buttons">
                    <button type="button" id="cancel-building-btn">Cancelar</button>
                    <button type="submit" id="save-building-btn">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="investment-modal" class="modal-overlay">
        <div class="modal-container">
            <h2 id="investment-title">Gerenciar Investimento</h2>
            <p>Saldo Atual: <span id="investment-balance">R$ 0,00</span></p>
            <form id="investment-form">
                 <label for="investment-amount">Valor:</label>
                 <input type="text" inputmode="decimal" id="investment-amount" placeholder="1000,00">
                 <div class="modal-buttons">
                     <button type="button" id="investment-cancel-btn">Fechar</button>
                     <button type="button" id="withdraw-btn">Sacar</button>
                     <button type="button" id="deposit-btn">Depositar</button>
                 </div>
            </form>
        </div>
    </div>

    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-container">
            <p id="confirm-message">Tem certeza?</p>
            <div class="modal-buttons">
                <button id="confirm-no-btn">Não</button>
                <button id="confirm-yes-btn">Sim</button>
            </div>
        </div>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- SELETORES ---
        const terrain = document.getElementById('terrain');
        const moneyDisplay = document.getElementById('money-display');
        const incomeRateDisplay = document.getElementById('income-rate-display');
        const incomeTimeUnit = document.getElementById('income-time-unit');
        const totalInvestedDisplay = document.getElementById('total-invested-display');
        const retainedEarningsDisplay = document.getElementById('retained-earnings-display');
        const demolishTool = document.getElementById('demolish-tool');
        const addMoneyBtn = document.getElementById('add-money');
        const subtractMoneyBtn = document.getElementById('subtract-money');
        const body = document.body;
        const createBtn = document.getElementById('create-building-btn');
        const resetBtn = document.getElementById('reset-game-btn');
        const customBuildingsContainer = document.getElementById('custom-buildings-container');
        const dateDisplay = document.getElementById('date-display');
        const clockDisplay = document.getElementById('clock-display');

        // Form/Modal de Criação
        const formModal = document.getElementById('form-modal');
        const creationForm = document.getElementById('creation-form');
        const cancelBtn = document.getElementById('cancel-building-btn');
        const formTitle = document.getElementById('form-title');
        const isInvestmentCheckbox = document.getElementById('is-investment-checkbox');
        const initialDepositInput = document.getElementById('initial-deposit');
        const autoReinvestCheckbox = document.getElementById('auto-reinvest-checkbox');
        const paydayCheckbox = document.getElementById('payday-checkbox');
        const paydayInputGroup = document.getElementById('payday-input-group');
        const paydayDayInput = document.getElementById('payday-day');
        const workScheduleCheckbox = document.getElementById('work-schedule-checkbox');
        const workScheduleInputGroup = document.getElementById('work-schedule-input-group');
        const workStartTimeInput = document.getElementById('work-start-time');
        const workEndTimeInput = document.getElementById('work-end-time');

        // Modal de Investimento
        const investmentModal = document.getElementById('investment-modal');
        const investmentTitle = document.getElementById('investment-title');
        const investmentBalance = document.getElementById('investment-balance');
        const investmentAmountInput = document.getElementById('investment-amount');
        const depositBtn = document.getElementById('deposit-btn');
        const withdrawBtn = document.getElementById('withdraw-btn');
        const investmentCancelBtn = document.getElementById('investment-cancel-btn');

        // Modal de Confirmação
        const confirmModal = document.getElementById('confirm-modal');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmYesBtn = document.getElementById('confirm-yes-btn');
        const confirmNoBtn = document.getElementById('confirm-no-btn');

        // --- CONSTANTES ---
        const SECONDS_IN_YEAR = 365.25 * 24 * 60 * 60;
        const SEGUNDOS_NO_MES = 30 * 24 * 60 * 60;
        const NUM_PLOTS = 70;
        const TIME_UNITS = [ { label: '/s', multiplier: 1 }, { label: '/min', multiplier: 60 }, { label: '/h', multiplier: 3600 }, { label: '/dia', multiplier: 86400 }, { label: '/sem', multiplier: 86400 * 7 }, { label: '/mês', multiplier: SEGUNDOS_NO_MES }, { label: '/ano', multiplier: SECONDS_IN_YEAR }];
        const SAVE_KEY = 'cityManagerSaveData';

        // --- ESTADO DO JOGO ---
        let totalMoney = 0;
        let retainedEarnings = 0;
        let buildingTypes = [];
        let buildingsOnTerrain = [];
        
        let isDemolishMode = false;
        let projectedIncomePerSecond = 0;
        let currentTimeUnitIndex = 0;
        let confirmCallback = null;
        let activeInvestmentPlot = null;
        let lastPayoutDay = -1;
        
        // --- PERSISTÊNCIA (SAVE/LOAD) ---
        const saveGameState = () => {
            const serializableBuildings = buildingsOnTerrain.map(b => {
                const serial = { ...b, plotId: b.plot.dataset.id };
                delete serial.plot;
                return serial;
            });
            const gameState = { totalMoney, retainedEarnings, lastPayoutDay, buildingTypes, buildingsOnTerrain: serializableBuildings };
            localStorage.setItem(SAVE_KEY, JSON.stringify(gameState));
        };
        
        const loadGameState = () => {
            const savedData = localStorage.getItem(SAVE_KEY);
            if (!savedData) return;
            const gameState = JSON.parse(savedData);
            totalMoney = gameState.totalMoney || 0;
            retainedEarnings = gameState.retainedEarnings || 0;
            lastPayoutDay = gameState.lastPayoutDay || -1;
            buildingTypes = gameState.buildingTypes || [];
            buildingTypes.forEach(typeData => addCustomBuildingToMenu(typeData));
            gameState.buildingsOnTerrain.forEach(savedBuilding => {
                const plot = terrain.querySelector(`.terrain-plot[data-id='${savedBuilding.plotId}']`);
                if (plot) {
                    const buildingData = { ...savedBuilding, plot };
                    buildingsOnTerrain.push(buildingData);
                    addBuildingVisualsToPlot(plot, buildingData);
                }
            });
            recalculateAllMetrics();
            updateMoneyDisplay();
            updateRetainedEarningsDisplay();
        };

        // --- FUNÇÕES DE LÓGICA E DISPLAY ---
        const formatCurrency = (value, options = {}) => value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL', ...options });
        const updateMoneyDisplay = () => moneyDisplay.textContent = formatCurrency(totalMoney);
        const updateRetainedEarningsDisplay = () => retainedEarningsDisplay.textContent = formatCurrency(retainedEarnings);
        
        const updateTotalInvestedDisplay = () => {
            const total = buildingsOnTerrain.filter(b => b.isInvestment).reduce((sum, b) => sum + b.balance, 0);
            totalInvestedDisplay.textContent = formatCurrency(total);
        };
        
        const updateIncomeDistributionPercentages = () => {
            const allTypeCards = document.querySelectorAll('#custom-buildings-container .build-option');
            if (projectedIncomePerSecond <= 0) {
                allTypeCards.forEach(card => {
                    const percentageEl = card.querySelector('.income-percentage');
                    if (percentageEl) percentageEl.textContent = '0%';
                });
                return;
            }
            allTypeCards.forEach(card => {
                const typeId = card.dataset.buildingId;
                let incomeFromThisType = 0;
                buildingsOnTerrain.forEach(building => {
                    if (building.typeId === typeId) {
                        incomeFromThisType += getBuildingProjectedIncomePerSecond(building);
                    }
                });
                const percentage = (incomeFromThisType / projectedIncomePerSecond) * 100;
                const percentageEl = card.querySelector('.income-percentage');
                if (percentageEl) { percentageEl.textContent = `${percentage.toFixed(1)}%`; }
            });
        };

        const updateIncomeRateDisplay = () => {
            const unit = TIME_UNITS[currentTimeUnitIndex];
            const incomeInUnit = projectedIncomePerSecond * unit.multiplier;
            let formattedRate;
            if (incomeInUnit > 0 && incomeInUnit < 0.01) {
                formattedRate = incomeInUnit.toLocaleString('pt-BR', { maximumFractionDigits: 8 });
            } else {
                formattedRate = incomeInUnit.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            }
            incomeRateDisplay.textContent = `+R$ ${formattedRate}`;
            incomeTimeUnit.textContent = unit.label;
            updateIncomeDistributionPercentages();
        };
        
        const checkForPayouts = () => {
            const today = new Date().getDate();
            if (today === lastPayoutDay) return;
            const typesToPay = buildingTypes.filter(type => type.hasPayDay && type.payDay === today);
            if (typesToPay.length > 0 && retainedEarnings > 0) {
                totalMoney += retainedEarnings;
                retainedEarnings = 0;
                updateMoneyDisplay();
                updateRetainedEarningsDisplay();
                lastPayoutDay = today;
                saveGameState();
            }
        };

        const updateTime = () => {
            const now = new Date();
            dateDisplay.textContent = now.toLocaleDateString('pt-BR');
            clockDisplay.textContent = now.toLocaleTimeString('pt-BR');
            checkForPayouts();
        };

        const getBuildingIncomePerSecond = (building) => {
            const type = buildingTypes.find(t => t.id === building.typeId);
            if (!type) return 0;
        
            if (type.isInvestment) {
                return building.balance * (type.apy / 100) / SECONDS_IN_YEAR;
            }
        
            if (type.hasWorkSchedule) {
                const [startH, startM] = type.workStartTime.split(':').map(Number);
                const startTimeInSeconds = startH * 3600 + startM * 60;
                const [endH, endM] = type.workEndTime.split(':').map(Number);
                let endTimeInSeconds = endH * 3600 + endM * 60;
                if (endTimeInSeconds <= startTimeInSeconds) endTimeInSeconds += 24 * 3600;
                const durationSeconds = endTimeInSeconds - startTimeInSeconds;
                const totalWorkSecondsInMonth = durationSeconds * 30;
                return type.income / totalWorkSecondsInMonth;
            }
            
            return type.income / SEGUNDOS_NO_MES;
        };

        const getBuildingProjectedIncomePerSecond = (building) => {
             const type = buildingTypes.find(t => t.id === building.typeId);
            if (!type) return 0;
        
            if (type.isInvestment) {
                return building.balance * (type.apy / 100) / SECONDS_IN_YEAR;
            }
            
            // **MUDANÇA AQUI:** Cálculo da projeção corrigido para horário de trabalho
            if (type.hasWorkSchedule) {
                const [startH, startM] = type.workStartTime.split(':').map(Number);
                const startTimeInSeconds = startH * 3600 + startM * 60;
                const [endH, endM] = type.workEndTime.split(':').map(Number);
                let endTimeInSeconds = endH * 3600 + endM * 60;
                if (endTimeInSeconds <= startTimeInSeconds) endTimeInSeconds += 24 * 3600;
                const durationSeconds = endTimeInSeconds - startTimeInSeconds;
                const dailyWorkRatio = durationSeconds / (24 * 3600); // Proporção do dia em que se trabalha
                return (type.income / SEGUNDOS_NO_MES) / dailyWorkRatio;
            }

            return type.income / SEGUNDOS_NO_MES;
        };
        
        const recalculateAllMetrics = () => {
            projectedIncomePerSecond = buildingsOnTerrain.reduce((sum, building) => sum + getBuildingProjectedIncomePerSecond(building), 0);
            updateIncomeRateDisplay();
            updateTotalInvestedDisplay();
            saveGameState();
        };

        const createMoneyPopup = (plot, amount) => {
            const popup = document.createElement('div');
            popup.classList.add('money-popup');
            const formattedAmount = amount.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 8 });
            popup.textContent = `R$ ${formattedAmount} +`;
            plot.appendChild(popup);
            setTimeout(() => popup.remove(), 1000);
        };

        const isWithinWorkHours = (building) => {
            if (!building.hasWorkSchedule) return true;
            const now = new Date();
            const currentTime = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();
            
            const [startH, startM] = building.workStartTime.split(':').map(Number);
            const startTimeInSeconds = startH * 3600 + startM * 60;
            
            const [endH, endM] = building.workEndTime.split(':').map(Number);
            let endTimeInSeconds = endH * 3600 + endM * 60;

            if (startTimeInSeconds <= endTimeInSeconds) { // Same day
                return currentTime >= startTimeInSeconds && currentTime < endTimeInSeconds;
            } else { // Overnight schedule
                return currentTime >= startTimeInSeconds || currentTime < endTimeInSeconds;
            }
        };

        const gameLoop = () => {
            let needsMetricRecalculation = false;
            let needsSave = false;
            
            buildingsOnTerrain.forEach(building => {
                let profit = 0;
                if (building.isInvestment && building.balance > 0) {
                    profit = building.balance * (building.apy / 100) / SECONDS_IN_YEAR;
                    if(building.autoReinvest) {
                        building.balance += profit;
                        updatePlotBalance(building.plot, building.balance);
                        needsMetricRecalculation = true;
                    } else {
                        totalMoney += profit;
                        needsSave = true;
                    }
                } else if (!building.isInvestment) {
                    if (isWithinWorkHours(building)) {
                        profit = building.incomePerSecond;
                        if (building.hasPayDay) {
                            retainedEarnings += profit;
                            updateRetainedEarningsDisplay();
                        } else {
                            totalMoney += profit;
                        }
                        needsSave = true;
                    }
                }
                
                if (profit > 0) {
                    createMoneyPopup(building.plot, profit);
                }
            });
            
            if (needsSave) { updateMoneyDisplay(); }
            if(needsMetricRecalculation) { recalculateAllMetrics(); } 
            else if (needsSave) { saveGameState(); }
        };

        const setDemolishMode = (isActive) => {
            isDemolishMode = isActive;
            body.classList.toggle('demolish-mode', isActive);
            demolishTool.classList.toggle('selected', isActive);
        };

        const updatePlotBalance = (plot, balance) => {
            let balanceEl = plot.querySelector('.plot-balance');
            if (!balanceEl) {
                balanceEl = document.createElement('div');
                balanceEl.className = 'plot-balance';
                plot.appendChild(balanceEl);
            }
            balanceEl.textContent = formatCurrency(balance);
        };
        
        const removeBuildingFromPlot = (plot) => {
            const buildingIndex = buildingsOnTerrain.findIndex(b => b.plot === plot);
            if (buildingIndex > -1) {
                const building = buildingsOnTerrain[buildingIndex];
                if (building.isInvestment && building.balance > 0) {
                    totalMoney += building.balance;
                    updateMoneyDisplay();
                }
                buildingsOnTerrain.splice(buildingIndex, 1);
                recalculateAllMetrics();
            }
            plot.innerHTML = '';
            plot.classList.remove('occupied', 'investment-plot');
            plot.style.cursor = 'pointer';
            delete plot.dataset.buildingId;
        };
        
        const parseReadableFloat = (str) => parseFloat(String(str).replace(/\./g, '').replace(',', '.'));
        
        const showConfirmation = (message, callback) => {
            confirmMessage.textContent = message;
            confirmCallback = callback;
            confirmModal.style.display = 'flex';
        };

        const hideConfirmation = () => {
            confirmModal.style.display = 'none';
            confirmCallback = null;
        };

        isInvestmentCheckbox.addEventListener('change', () => {
            document.querySelectorAll('.income-field').forEach(el => el.style.display = isInvestmentCheckbox.checked ? 'none' : 'flex');
            document.querySelectorAll('.apy-field').forEach(el => el.style.display = isInvestmentCheckbox.checked ? 'flex' : 'none');
            document.getElementById('building-income').required = !isInvestmentCheckbox.checked;
            document.getElementById('building-apy').required = isInvestmentCheckbox.checked;
        });
        
        paydayCheckbox.addEventListener('change', () => {
            paydayInputGroup.style.display = paydayCheckbox.checked ? 'flex' : 'none';
            paydayDayInput.required = paydayCheckbox.checked;
        });
        
        workScheduleCheckbox.addEventListener('change', () => {
            workScheduleInputGroup.style.display = workScheduleCheckbox.checked ? 'flex' : 'none';
            workStartTimeInput.required = workScheduleCheckbox.checked;
            workEndTimeInput.required = workScheduleCheckbox.checked;
        });

        const addCustomBuildingToMenu = (data) => {
            const { name, emoji, income, isInvestment, apy, initialDeposit, id, autoReinvest, hasPayDay, payDay, hasWorkSchedule, workStartTime, workEndTime } = data;
            const buildingId = id || crypto.randomUUID();
            
            const option = document.createElement('div');
            option.className = 'build-option';
            option.draggable = true;
            option.dataset.buildingId = buildingId;
            
            let infoHtml = '';
            let controlsHtml = `<button class="type-control-btn edit-btn" title="Editar">✏️</button><button class="type-control-btn delete-btn" title="Apagar">❌</button>`;
            if (isInvestment) {
                option.classList.add('investment-type');
                infoHtml = `Rendimento: ${apy.toLocaleString('pt-BR')}%/ano`;
                if(autoReinvest) infoHtml += ' 🔄';
                controlsHtml = `<button class="type-control-btn add-funds-btn" title="Aportar em todos">+</button>` + controlsHtml;
            } else {
                infoHtml = `<strong>Renda:</strong> R$ ${income.toLocaleString('pt-BR', {minimumFractionDigits: 2})}/mês`;
                if(hasPayDay) infoHtml += `<br><span>(Dia de Pagamento: ${payDay})</span>`;
                if(hasWorkSchedule) infoHtml += `<br><span>(⏰ ${workStartTime}-${workEndTime})</span>`;
            }
            
            option.innerHTML = `<div class="income-percentage">0%</div><div class="type-controls">${controlsHtml}</div><span class="menu-emoji">${emoji}</span><div class="build-info"><strong>${name}</strong><div>${infoHtml}</div></div>`;
            
            attachDraggableLogic(option);
            if (isInvestment) {
                option.querySelector('.add-funds-btn').addEventListener('click', (e) => { e.stopPropagation(); handleGlobalDeposit(buildingId); });
            }
            option.querySelector('.edit-btn').addEventListener('click', (e) => { e.stopPropagation(); handleEditType(buildingId); });
            option.querySelector('.delete-btn').addEventListener('click', (e) => { e.stopPropagation(); handleDeleteType(buildingId); });

            customBuildingsContainer.appendChild(option);
            return { element: option, id: buildingId };
        };

        const attachDraggableLogic = (element) => {
             element.addEventListener('dragstart', (e) => {
                if (e.target.classList.contains('type-control-btn')) { e.preventDefault(); return; }
                setDemolishMode(false);
                e.target.classList.add('dragging');
                const typeId = element.dataset.buildingId;
                const typeData = buildingTypes.find(t => t.id === typeId);
                e.dataTransfer.setData('application/json', JSON.stringify(typeData));
            });
            element.addEventListener('dragend', (e) => e.target.classList.remove('dragging'));
        }

        const handleEditType = (buildingId) => {
            const type = buildingTypes.find(t => t.id === buildingId);
            if (!type) return;

            isInvestmentCheckbox.checked = type.isInvestment;
            isInvestmentCheckbox.dispatchEvent(new Event('change'));

            document.getElementById('building-name').value = type.name;
            document.getElementById('building-emoji').value = type.emoji;
            if(type.isInvestment) {
                 document.getElementById('building-apy').value = (type.apy || 0).toLocaleString('pt-BR', {useGrouping: false});
                 initialDepositInput.value = (type.initialDeposit || 0).toLocaleString('pt-BR', {useGrouping: false});
                 autoReinvestCheckbox.checked = type.autoReinvest !== false;
            } else {
                 document.getElementById('building-income').value = (type.income || 0).toLocaleString('pt-BR', {useGrouping: false, minimumFractionDigits: 2});
                 paydayCheckbox.checked = type.hasPayDay;
                 paydayCheckbox.dispatchEvent(new Event('change'));
                 paydayDayInput.value = type.payDay || 1;
                 workScheduleCheckbox.checked = type.hasWorkSchedule;
                 workScheduleCheckbox.dispatchEvent(new Event('change'));
                 workStartTimeInput.value = type.workStartTime || "08:00";
                 workEndTimeInput.value = type.workEndTime || "18:00";
            }

            formTitle.textContent = "Editar Construção";
            creationForm.dataset.editingId = buildingId;
            formModal.style.display = 'flex';
        };

        const handleDeleteType = (buildingId) => {
            const type = buildingTypes.find(t => t.id === buildingId);
            if (!type) return;
            const message = `Tem certeza que deseja apagar "${type.name}"? Todas as construções deste tipo no terreno também serão removidas.`;
            showConfirmation(message, () => {
                const plotsToRemove = Array.from(terrain.children).filter(p => p.dataset.buildingId === buildingId);
                plotsToRemove.forEach(plot => removeBuildingFromPlot(plot));
                const buildingCard = document.querySelector(`.build-option[data-building-id='${buildingId}']`);
                if (buildingCard) buildingCard.remove();
                buildingTypes = buildingTypes.filter(t => t.id !== buildingId);
                recalculateAllMetrics();
            });
        };

        const handleGlobalDeposit = (buildingId) => {
            const type = buildingTypes.find(t => t.id === buildingId);
            if (!type) return;
            const targetInvestments = buildingsOnTerrain.filter(b => b.typeId === buildingId);
            if(targetInvestments.length === 0) {
                alert(`Você precisa ter pelo menos um investimento "${type.name}" no terreno para fazer um aporte.`); return;
            }
            const amountStr = prompt(`Quanto deseja aportar em cada um dos ${targetInvestments.length} investimentos "${type.name}"?`);
            if(!amountStr) return;
            const amountPerInvestment = parseReadableFloat(amountStr);
            if(isNaN(amountPerInvestment) || amountPerInvestment <= 0) { alert("Valor inválido."); return; }
            const totalCost = amountPerInvestment * targetInvestments.length;
            if(totalMoney < totalCost) { alert(`Dinheiro insuficiente. Você precisa de ${formatCurrency(totalCost)}.`); return; }
            totalMoney -= totalCost;
            targetInvestments.forEach(investment => {
                investment.balance += amountPerInvestment;
                updatePlotBalance(investment.plot, investment.balance);
            });
            updateMoneyDisplay();
            recalculateAllMetrics();
        };
        
        const openCreateModal = () => {
            formTitle.textContent = "Nova Construção";
            creationForm.reset();
            isInvestmentCheckbox.checked = false;
            autoReinvestCheckbox.checked = true;
            paydayCheckbox.checked = false;
            workScheduleCheckbox.checked = false;
            isInvestmentCheckbox.dispatchEvent(new Event('change'));
            paydayCheckbox.dispatchEvent(new Event('change'));
            workScheduleCheckbox.dispatchEvent(new Event('change'));
            delete creationForm.dataset.editingId;
            formModal.style.display = 'flex';
        };
        createBtn.addEventListener('click', openCreateModal);
        cancelBtn.addEventListener('click', () => formModal.style.display = 'none');
        formModal.addEventListener('click', (e) => { if (e.target === formModal) formModal.style.display = 'none'; });

        creationForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('building-name').value;
            const emoji = document.getElementById('building-emoji').value;
            const isInvestment = isInvestmentCheckbox.checked;
            const editingId = creationForm.dataset.editingId;

            const data = { id: editingId || crypto.randomUUID(), name, emoji, isInvestment };
            
            if(isInvestment) {
                const apy = parseReadableFloat(document.getElementById('building-apy').value);
                const initialDeposit = parseReadableFloat(initialDepositInput.value) || 0;
                if (isNaN(apy) || apy < 0) { alert("Rendimento anual inválido."); return; }
                if (isNaN(initialDeposit) || initialDeposit < 0) { alert("Aporte inicial inválido."); return; }
                data.apy = apy;
                data.initialDeposit = initialDeposit;
                data.autoReinvest = autoReinvestCheckbox.checked;
            } else {
                const income = parseReadableFloat(document.getElementById('building-income').value);
                if (isNaN(income) || income < 0) { alert("Renda mensal inválida."); return; }
                data.income = income;
                
                data.hasPayDay = paydayCheckbox.checked;
                if (data.hasPayDay) {
                    const day = parseInt(paydayDayInput.value, 10);
                    if (isNaN(day) || day < 1 || day > 31) { alert("Dia de pagamento inválido."); return; }
                    data.payDay = day;
                }
                
                data.hasWorkSchedule = workScheduleCheckbox.checked;
                if (data.hasWorkSchedule) {
                    if(!workStartTimeInput.value || !workEndTimeInput.value) { alert("Horários de trabalho inválidos."); return; }
                    data.workStartTime = workStartTimeInput.value;
                    data.workEndTime = workEndTimeInput.value;
                }
            }
            
            if (editingId) {
                const typeIndex = buildingTypes.findIndex(t => t.id === editingId);
                if (typeIndex > -1) buildingTypes[typeIndex] = data;
                const card = document.querySelector(`.build-option[data-building-id='${editingId}']`);
                if (card) { card.remove(); }
                buildingsOnTerrain.forEach(building => {
                    if (building.typeId === editingId) {
                        Object.assign(building, data);
                        if(data.isInvestment) {
                            delete building.incomePerSecond;
                            addBuildingVisualsToPlot(building.plot, building);
                        } else {
                            building.incomePerSecond = getBuildingIncomePerSecond(building);
                            delete building.apy;
                            delete building.autoReinvest;
                            if (building.balance > 0) { totalMoney += building.balance; building.balance = 0; }
                            removeBuildingVisualsFromPlot(building.plot);
                            building.plot.classList.remove('investment-plot');
                        }
                    }
                });
            } else {
                buildingTypes.push(data);
            }
            
            addCustomBuildingToMenu(data);
            recalculateAllMetrics();
            formModal.style.display = 'none';
        });

        const addBuildingVisualsToPlot = (plot, buildingData) => {
            plot.innerHTML = '';
            plot.classList.add('occupied');
            plot.dataset.buildingId = buildingData.typeId;

            const typeInfo = buildingTypes.find(t => t.id === buildingData.typeId);
            if (typeInfo) {
                const buildingEmoji = document.createElement('span');
                buildingEmoji.textContent = typeInfo.emoji;
                buildingEmoji.className = 'plot-emoji';
                plot.appendChild(buildingEmoji);
            }

            if (buildingData.isInvestment) {
                plot.classList.add('investment-plot');
                updatePlotBalance(plot, buildingData.balance);
            }
        };
        
        const removeBuildingVisualsFromPlot = (plot) => {
            plot.innerHTML = '';
        }

        const handleDrop = (plot, event) => {
            if (plot.classList.contains('occupied')) return;
            const typeData = JSON.parse(event.dataTransfer.getData('application/json'));
            
            const buildingData = { plot, typeId: typeData.id, ...typeData };
            
            if (buildingData.isInvestment) {
                const initialDeposit = typeData.initialDeposit || 0;
                if(totalMoney < initialDeposit){
                    alert(`Dinheiro insuficiente para o aporte inicial de ${formatCurrency(initialDeposit)}.`);
                    return;
                }
                totalMoney -= initialDeposit;
                buildingData.balance = initialDeposit;
            } else {
                buildingData.incomePerSecond = getBuildingIncomePerSecond(buildingData);
            }
            buildingsOnTerrain.push(buildingData);
            
            addBuildingVisualsToPlot(plot, buildingData);
            updateMoneyDisplay();
            recalculateAllMetrics();
        };

        const handlePlotClick = (plot) => {
            if (isDemolishMode && plot.classList.contains('occupied')) {
                removeBuildingFromPlot(plot); return;
            }
            
            const building = buildingsOnTerrain.find(b => b.plot === plot);
            if (building && building.isInvestment) {
                activeInvestmentPlot = plot;
                const typeInfo = buildingTypes.find(t => t.id === building.typeId);
                investmentTitle.textContent = `Gerenciar "${typeInfo.name}"`;
                investmentBalance.textContent = formatCurrency(building.balance);
                investmentAmountInput.value = '';
                investmentModal.style.display = 'flex';
            }
        };

        const resetGame = () => {
            showConfirmation("Tem certeza que deseja reiniciar o jogo? O terreno e os saldos serão limpos, mas os tipos de construção serão mantidos.", () => {
                buildingsOnTerrain = [];
                Array.from(terrain.children).forEach(plot => {
                    plot.innerHTML = '';
                    plot.classList.remove('occupied', 'investment-plot');
                    plot.style.cursor = 'pointer';
                    delete plot.dataset.buildingId;
                });
                
                totalMoney = 0;
                retainedEarnings = 0;
                lastPayoutDay = -1;
                
                updateMoneyDisplay();
                updateRetainedEarningsDisplay();
                recalculateAllMetrics();
            });
        };

        // --- INICIALIZAÇÃO E EVENTOS ---
        for (let i = 0; i < NUM_PLOTS; i++) {
            const plot = document.createElement('div');
            plot.className = 'terrain-plot'; plot.dataset.id = i;
            plot.addEventListener('click', () => handlePlotClick(plot));
            plot.addEventListener('dragover', (e) => { e.preventDefault(); if(!plot.classList.contains('occupied')) plot.classList.add('drag-over'); });
            plot.addEventListener('dragleave', () => plot.classList.remove('drag-over'));
            plot.addEventListener('drop', (e) => { e.preventDefault(); plot.classList.remove('drag-over'); handleDrop(plot, e); });
            terrain.appendChild(plot);
        }

        addMoneyBtn.addEventListener('click', () => {
            const amountStr = prompt("Quanto dinheiro deseja adicionar?", "1000");
            if (amountStr) {
                const amount = parseReadableFloat(amountStr);
                if (!isNaN(amount) && amount > 0) { totalMoney += amount; updateMoneyDisplay(); saveGameState();}
            }
        });
        subtractMoneyBtn.addEventListener('click', () => {
            const amountStr = prompt("Quanto dinheiro deseja subtrair?", "500");
            if (amountStr) {
                const amount = parseReadableFloat(amountStr);
                if (isNaN(amount) || amount <= 0) return;
                if (totalMoney >= amount) { totalMoney -= amount; updateMoneyDisplay(); saveGameState(); } 
                else { alert("Você não pode subtrair mais dinheiro do que possui."); }
            }
        });
        incomeTimeUnit.addEventListener('click', () => {
            currentTimeUnitIndex = (currentTimeUnitIndex + 1) % TIME_UNITS.length;
            updateIncomeRateDisplay();
        });
        demolishTool.addEventListener('click', () => setDemolishMode(!isDemolishMode));
        resetBtn.addEventListener('click', resetGame);
        
        investmentCancelBtn.addEventListener('click', () => investmentModal.style.display = 'none');
        depositBtn.addEventListener('click', () => {
            const amount = parseReadableFloat(investmentAmountInput.value);
            const building = buildingsOnTerrain.find(b => b.plot === activeInvestmentPlot);
            if(isNaN(amount) || amount <= 0) { alert('Valor inválido.'); return; }
            if(totalMoney < amount) { alert('Dinheiro insuficiente.'); return; }
            totalMoney -= amount;
            building.balance += amount;
            investmentBalance.textContent = formatCurrency(building.balance);
            investmentAmountInput.value = '';
            recalculateAllMetrics();
        });
        withdrawBtn.addEventListener('click', () => {
            const amount = parseReadableFloat(investmentAmountInput.value);
            const building = buildingsOnTerrain.find(b => b.plot === activeInvestmentPlot);
            if(isNaN(amount) || amount <= 0) { alert('Valor inválido.'); return; }
            if(building.balance < amount) { alert('Saldo insuficiente no investimento.'); return; }
            totalMoney += amount;
            building.balance -= amount;
            investmentBalance.textContent = formatCurrency(building.balance);
            investmentAmountInput.value = '';
            recalculateAllMetrics();
        });

        confirmYesBtn.addEventListener('click', () => {
            if (confirmCallback) confirmCallback();
            hideConfirmation();
        });
        confirmNoBtn.addEventListener('click', hideConfirmation);
        confirmModal.addEventListener('click', (e) => { if (e.target === confirmModal) hideConfirmation(); });
        
        // --- INÍCIO DO JOGO ---
        loadGameState();
        updateTime();
        setInterval(gameLoop, 1000);
        setInterval(updateTime, 1000);
    });
</script>

</body>
</html>
